#!/usr/bin/env ruby
require 'rubygems'
begin
  require 'bundler'
  Bundler.setup
rescue Exception => e
end

here = File.expand_path(File.dirname __FILE__)
$:<< "#{here}/../lib"

require 'optparse'
begin
  require 'rake/dsl_definition'
rescue Exception => e
  # We might just be on an old version of Rake...
end
require 'rake'
require 'annotate'
require 'annotate/annotate_models'
require 'annotate/annotate_routes'

if File.exists?('Rakefile')
  load './Rakefile'
else
  STDERR.puts "Can't find Rakefile. Are we in a Rails folder?"
end
Rake::Task[:environment].invoke
Annotate.load_tasks
Rake::Task[:set_annotation_options].invoke

target = {
  :klass => AnnotateModels,
  :task => :do_annotations,
}
has_set_position = {}
OptionParser.new do |opts|
  opts.banner = "Usage: annotate [options] [ModelName]*"

  AnnotateModels::OPTIONS.call(opts)
  AnnotateRoutes::OPTIONS.call(opts)
  Annotate::OPTIONS.call(opts, :both, has_set_position, target)
end.parse!


Annotate.eager_load
require "annotate/active_record_patch"
options=Annotate.setup_options({ :is_rake => !ENV['is_rake'].blank? })
options[:require].each { |path| require path } if options[:require]
target[:klass].send(target[:task], options)
