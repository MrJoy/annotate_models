#!/usr/bin/env ruby
require 'rubygems'
require 'bundler'
Bundler.setup

here = File.expand_path(File.dirname __FILE__)
$:<< "#{here}/../lib"

require 'optparse'
begin
  require 'rake/dsl_definition'
rescue Exception => e
  # We might just be on an old version of Rake...
end
require 'rake'
require 'annotate'
require 'annotate/annotate_routes'

if File.exists?('Rakefile')
  load './Rakefile'
else
  STDERR.puts "Can't find Rakefile. Are we in a Rails folder?"
end
Rake::Task[:environment].invoke
Annotate.load_tasks
Rake::Task[:set_annotation_options].invoke

task = "do_annotate"
has_set_position = {}
OptionParser.new do |opts|
  opts.banner = "Usage: annotate_routes [options]"

  AnnotateRoutes::OPTIONS.call(opts)
  Annotate::OPTIONS.call(opts, :routes, has_set_position, task)
end.parse!

options=Annotate.setup_options({ :is_rake => true })
options[:require].each { |path| require path } if options[:require]
AnnotateRoutes.send(task.to_sym, options)
